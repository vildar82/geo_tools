Структура папок и пользовательские данные.
<p>Здесь описывается, содержимое каталогов geo_tools. И немного о том как инструменты работают.</p>
<p>Открыв каталог <span class="italic">C:/Program Files/geo_tools</span> мы увидим:</p>
<p>папка <span class="bold">bloks</span> предназначена для хранения блоков условных знаков и их элементов. Большинство инструментов вставляющих блоки в чертеж берут их от сюда. Каталог добавлен в перечень папок автокада как содержащая вспомогательные файлы. Алгоритм вставки блока - блок с указанным именем ищется в текущем чертеже если не найден то ищется файл <span class="italic">.dwg</span> с таким именем в папках вспомогательных файлов если такой файл есть вставляет его как блок если нет выдает ошибку и перечень каталогов где искал и не нашел. Ничего нового не изобрел, так работает стандартная команда автокада INSERT. Она и используется в лиспе обернутая вопросами "какой блок" и "будем ли вращать" так, чтобы их удобно было указать в макросе на кнопке. Но не все так просто - с аннотативными блоками их нельзя сделать таковыми при вставке соответствующего файла - создается обычный блок. Нужно хранить аннотативные блоки в файле в виде блока. Создавать для каждого блока отдельный файл чтобы после каждой вставки нового блока чистить мусор в блоках посчитал неразумным. Сейчас все аннотативные блоки находятся в файле <span class="italic">annotative_bloks.dwg</span> и именно он подгружается, если нужного аннотативного блока нет в чертеже. Для вставки аннототивных блоков используется команда <span class="italic">draw_insert_blok_annotative</span>, а для всех остальных <span class="italic">draw_insert_blok_easy</span>.</p>
<p><span class="bold">data</span> – каталог содержит данные которые используют geo_tools и хранят не в текущем чертеже. Эта папка также добавлена в настройки автокада в пути вспомогательных файлов. Здесь располагаются файлы содержащие форматы листов, шаблоны подвалов профилей, типы линий и мультилиний. Все файлы текстовые. Со временем собираюсь перевести все данные в <span class="italic">xml</span> формат.</p>
<p><span class="bold">fonts</span> – каталог добавлен в настройки автокада в пути вспомогательных файлов. Содержит файлы автокадовских шрифтов и блоков линий.</p>
<p><span class="bold">helps</span> – так же добавлен в настройки автокада в пути вспомогательных файлов. Справки, файлы для иллюстрации разделов учебника в справке. Собираюсь сделать справку сегодняшних geo_tools пока имеем вариант позапрошлогодней давности.</p>
<p><span class="bold">icons</span> – иконки для единственной панели инструментов geo_tools. Эксперимент, не получивший развития. Как выглядит можно посмотреть, нажав кнопку "Каталог исходных пунктов" в палитре "Прочие". Панель появляется только на текущий сеанс автокада.</p>
<p><span class="bold">lisp</span> - так же добавлен в настройки автокада, в пути вспомогательных файлов. Собственно папка с лисп функциями на которых все работает. После каждого запуска автокада эта директория сканируется и загружаются все файлы с расширением <span class="italic">.lsp</span> в пути которых нет строки "<span class="italic">=dont-load=</span>", если есть такой файл игнорируется. В папке "<span class="italic">=dont-load=and=dont-comile=</span>" как раз находится склад того, что грузить не надо, а выкинуть жалко. Вторая часть имени папки осталась с тех пор как я пытался компилировать лиспы в <span class="italic">.vlx</span>, но полностью автоматизировать этот процесс мне не удалось, поэтому бросил. Так же есть файлы с расширением <span class="italic">.arx</span> это бесплатные программки Александра Ривилиса взятые от <a href="http://www.maestrogroup.com.ua/support/" target="_blank">сюда</a>. Позволяют взрывать прокси объекты и конвертировать текст в автокаде в разные кодировки. Разные файлы для разных автокадов все версии есть в папке <span class="italic">help</span> в архивах, там же инструкция по применению.</p>
<p><span class="bold">template</span> – шаблоны новых файлов для команды <span class="italic">БСоздать</span> по версиям автокада. А также шаблон для нового штампа <span class="italic">.sht</span> и пустой каталог координат <span class="italic">.xml</span>.</p>
<p><span class="bold">ToolPalette</span> – каталог содержит файлы палитр инструментов Geo_Tools.</p>
<p><span class="bold">uninstall</span> – содержит папку со шрифтами которые надо ставить в Windows “<span class="italic">win_fonts</span>”, а также <span class="italic">bat</span> файл упаковывающий geo_tools для того чтобы кому ни будь отдать(работает на XP и должен стоять 7zip). Дурацкое название для папки, и задумывалась она для других целей, но так исторически сложилось и пока не собираюсь менять.</p>
<p><span class="bold">acaddoc.lsp</span> – важный файл. Этот файл грузится первым и подгружает остальные. Во время первого запуска, при установке, добавляются необходимые настройки в автокад и создаются пользовательские файлы (о них чуть ниже), при последующих - открытии каждого файла, эти настройки проверяются и при надобности исправляются как должно.</p>
<p><span class="bold">version.txt</span> – файл содержит дату и время текущей версии без разделителей.</p>
<p>Теперь о пользовательских файлах. Немного истории: Говорит мне мой коллега однажды - хочу подправить кой чего в шаблоне. Я предлагаю мол скажи сделаю. Он - нет самому интересно. Показываю ему как пересохранить геотулсовский шаблон и думаю, а ведь когда он новую версию с новыми кнопочками ставить будет все его старания затрутся. Не хорошо.</p>
<p>Теперь о том как реализовано чтобы не терялись правки пользователей. При установке по пути <span class="italic">c:\Documents and Settings\[пользователь]\Application Data\</span> (для Win7 <span class="italic">c:\Users\[пользователь]\AppData\Roaming\</span>) создается каталог <span class="italic">geo_tools</span> в который копируются все те файлы из каталога <span class="italic">c:\Program Files\geo_tools\</span> которые изменяет пользователь в процессе работы, включая шаблоны. То есть <span class="italic">data</span> и <span class="italic">templetes</span> почти в полном составе. Заготовлены пустые папки <span class="italic">bloks</span>, <span class="italic">fonts</span>, <span class="italic">lisp</span> и <span class="italic">uninstall</span>. Эти папки (кроме последней) добавлены в пути вспомогательных файлов автокада, причем выше всех остальных папок, что означает что при поиске файла автокад будет искать сначала в пользовательских папках, и если не найдет, поиск продолжится в программных файлах. Так же как и из программных файлов лиспы грузятся и из пользовательской папки, но последними то есть пользовательская функция заменит одноименную из программных файлов (следует делать так когда в самом деле знаешь что делаешь).</p>
<p>Если пользователь слишком много наредактировал в своих файлах то с помощью команды "Сброс пользовательских данных" в палитре "Настройки" можно заменить выбранные пользовательские файлы теми что в программных файлах. При отсутствии каких то файлов пользовательских данных они будут автоматически восстановлены из программных файлов при следующем запуске автокада.</p>
<p>Резюме. Пользовательские данные находятся <span class="italic">c:\Documents and Settings\[пользователь]\Application Data\geo_tool</span> это копия файлов из соответствующих папок в <span class="italic">C:/Program Files/geo_tools</span>. При работе с инструментами используются и изменяются именно пользовательские данные не перезаписываемые при обновлении geo_tools. Вернуть к первоначальным пользовательские данные можно командой "Сброс пользовательских данных" в палитре "Настройки".</p>
<div class="data"><p>2013.01.31</p></div>